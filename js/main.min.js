document.addEventListener('DOMContentLoaded', () => {
  const logsContainer = document.getElementById('boot-logs');
  const memContainer = document.getElementById('memory-check');
  const bootEl = document.getElementById('boot');
  const mainEl = document.getElementById('main');
  const toodaBtn = document.getElementById('team-tooda-btn');
  const toodaPanel = document.getElementById('team-tooda-panel');
  const citadelBtn = document.getElementById('citadel-btn');
  const citadelPanel = document.getElementById('citadel-panel');
  const bgAudio = document.getElementById('bg-audio');
  const bootLogo = document.getElementById('boot-logo');

const titleFrames = [
    '  ',
    ' / ',
    ' /\\ ',
    ' A ',
    ' A| ',
    ' A|\\ ',
    ' A|\\| ',
    ' A|\\| ',
    ' An ',
    ' An@ ',
    ' Ang ',
    ' Ang3 ',
    ' Ange ',
    ' Ange| ',
    ' Ange|2 ',
    ' Ange|_ ',
    ' Angel ',
    ' Angel| ',
    ' Angel|> ',
    ' Angelp ',
    ' Angelp\/ ',
    ' Angelp\/\/ ',
    ' Angelpw',
    ' Angelpw|',
    ' Angelpw|\ ',
    ' Angelpw|\\',
    ' Angelpw|\\|',
    ' Angelpwn',
    ' Angelpwn.',
    ' Angelpwn.<',
    ' Angelpwn.c',
    ' Angelpwn.c<',
    ' Angelpwn.cc',
    ' Angelpwn.cc',
    ' Angelpwn.cc',
    ' Angelpwn.cc',
    ' Angelpwn.c<',
    ' Angelpwn.c',
    ' Angelpwn.<',
    ' Angelpwn.',
    ' Angelpwn',
    ' Angelpw|\\|',
    ' Angelpw|\\',
    ' Angelpw|\\ ',
    ' Angelpw|',
    ' Angelpw',
    ' Angelp\/\/ ',
    ' Angelp\/ ',
    ' Angelp ',
    ' Angel|>',
    ' Angel| ',
    ' Angel ',
    ' Ange|_ ',
    ' Ange|2 ',
    ' Ange| ',
    ' Ange ',
    ' Ang3 ',
    ' Ang ',
    ' An@ ',
    ' An ',
    ' A|\\| ',
    ' A|\\ ',
    ' A|\ ',
    ' A| ',
    ' A ',
    ' /\\ ',
    ' / ',
    ' | ',
    '  ',
    ''
];
  let titleFrame = 0;
  setInterval(() => {
    try {
      document.title = titleFrames[titleFrame] || 'Angelpwn.cc';
    } catch (e) {}
    titleFrame = (titleFrame + 1) % titleFrames.length;
  }, 250);

  const bootLines = [
    { type: 'info', text: 'Loading kernel modules...' },
    { type: 'success', text: 'CPU: AMD Threadripper PRO 7995WX detected at 5.1 GHz' },
    { type: 'success', text: 'Memory: 64GB DDR5-6000 CL30 initialized' },
    { type: 'info', text: 'Running memory diagnostic...' },
    { type: 'success', text: 'Initializing PCI devices...' },
    { type: 'success', text: 'Loading system drivers: nvidia.ko, audio.ko, net.ko' },
    { type: 'warning', text: 'ACPI: Temperature threshold warning (CPU: 75°C)' },
    { type: 'info', text: 'Starting system services [1/3]...' },
    { type: 'info', text: 'Starting system services [2/3]...' },
    { type: 'info', text: 'Starting system services [3/3]...' },
  ];

  const logDelay = 100;
  bootLines.forEach((line, i) => {
    const el = document.createElement('div');
    el.className = `boot-log ${line.type}`;
    el.textContent = ` ${line.text}`;
    el.style.animationDelay = `${i * logDelay}ms`;
    setTimeout(() => {
      el.classList.add('show');
    }, 10);
    logsContainer.appendChild(el);
  });

  const blocks = 200;
  if (memContainer) {
    const frag = document.createDocumentFragment();
    for (let i = 0; i < blocks; i++) {
      const b = document.createElement('span');
      b.className = 'memory-block';
      b.style.animationDelay = `${(i * 20)}ms`;
      frag.appendChild(b);
    }
    memContainer.appendChild(frag);
  }

  let bootFinished = false;
  const finishBoot = () => {
    if (bootFinished) return;
    bootFinished = true;
    bootEl.classList.add('hidden');
    if (mainEl) {
      mainEl.classList.remove('hidden');
      try { mainEl.style.removeProperty('display'); } catch(e) {}
    }
    document.body.classList.add('ready');
    const staged = document.querySelectorAll('.menu, .menu-header, .menu-items');
    staged.forEach(el => {
      if (!el) return;
      el.classList.add('show');
    });
    const stagedItems = document.querySelectorAll('.menu-items .menu-item');
    stagedItems.forEach(el => {
      if (!el) return;
      el.classList.add('show');
    });
    const menuHeader = document.querySelector('.menu-header');
    if (bootLogo && menuHeader) {
      menuHeader.insertBefore(bootLogo, menuHeader.firstChild);
      const nickEl = menuHeader.querySelector('.nick');
      if (nickEl && !nickEl.classList.contains('sync-glow')) {
        nickEl.classList.add('sync-glow');
      }
      if (!bootLogo.classList.contains('sync-glow')) {
        bootLogo.classList.add('sync-glow');
      }
    }
  };

  let continueBound = false;
  let finishingSequence = false;
  const enableContinue = () => {
    if (continueBound) return;
    continueBound = true;
    const triggerFinish = () => {
      if (finishingSequence) return;
      finishingSequence = true;
      if (bgAudio) {
        try {
          bgAudio.volume = 0.25;
          bgAudio.play().catch(() => {});
        } catch (e) {}
      }
      finishBoot();
    };
    const detach = () => {
      window.removeEventListener('click', clickHandler);
      window.removeEventListener('keydown', keyHandler);
    };
    const clickHandler = () => {
      detach();
      triggerFinish();
    };
    const keyHandler = (e) => {
      if (e.key !== 'Enter') return;
      detach();
      triggerFinish();
    };
    window.addEventListener('click', clickHandler);
    window.addEventListener('keydown', keyHandler);
  };

  let animationReady = false;
  let pageLoaded = false;
  const tryEnable = () => { if (animationReady && pageLoaded) enableContinue(); };

  const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  setTimeout(() => { animationReady = true; tryEnable(); }, prefersReducedMotion ? 300 : 4500);
  window.addEventListener('load', () => { pageLoaded = true; tryEnable(); });

  const triggerBtnFX = () => {};
  const setPanel = (show) => {
    if (!toodaPanel || !toodaBtn) return;
    if (show) {
      toodaPanel.classList.add('show');
      toodaPanel.setAttribute('aria-hidden', 'false');
      toodaBtn.setAttribute('aria-expanded', 'true');
    } else {
      toodaPanel.classList.remove('show');
      toodaPanel.setAttribute('aria-hidden', 'true');
      toodaBtn.setAttribute('aria-expanded', 'false');
    }
  };

  if (toodaBtn && toodaPanel) {
    let open = false;
    const toggle = () => {
      open = !open; setPanel(open);
      if (open && citadelPanel) {
        citadelPanel.classList.remove('show');
        citadelPanel.setAttribute('aria-hidden', 'true');
        if (citadelBtn) citadelBtn.setAttribute('aria-expanded', 'false');
      }
    };
    toodaBtn.addEventListener('click', (e) => { triggerBtnFX(toodaBtn, e); toggle(); });
    toodaBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        triggerBtnFX(toodaBtn);
        toggle();
      }
    });
    document.addEventListener('click', (e) => {
      const po = document.getElementById('proof-overlay');
      if (po && po.classList.contains('show')) return;
      if (!open) return;
      const t = e.target;
      if (!toodaPanel.contains(t) && t !== toodaBtn) { open = false; setPanel(false); }
    });

    const names = ['Eco','Emo','Elo','user','Dante','Sevy'];
    const header = toodaPanel.querySelector('.team-list h2');
    if (header) header.textContent = 'TOoDA Team';
    const ul = toodaPanel.querySelector('.team-list .nick-list');
    if (ul) {
      ul.innerHTML = '';
      names.forEach(n => {
        const li = document.createElement('li');
        li.textContent = n;
        ul.appendChild(li);
      });
    }
    const storyWrap = toodaPanel.querySelector('.story');
    if (storyWrap) {
      const narrative = `On February 9, I warned a close associate connected to Doxbin moderator "Hardline" and gave them four days to fix a vulnerability. After the deadline passed with no action taken, on February 13, 2025, the Doxbin database was leaked as a lesson for their irresponsibility. This is the message Graveyard received afterwards:`;
      const code = `https://186.2.171.20/login_up.php\nhttps://186.2.171.20/cp/javascript/main.min.js\nhttps://186.2.171.20/cp/javascript/vendors.js`;
      storyWrap.innerHTML = `<p>${narrative}</p><pre><code>${code}</code></pre>`;
    }
  }

  if (citadelBtn && citadelPanel) {
    const setPanelC = (show) => {
      if (show) {
        citadelPanel.classList.add('show');
        citadelPanel.setAttribute('aria-hidden', 'false');
        citadelBtn.setAttribute('aria-expanded', 'true');
      } else {
        citadelPanel.classList.remove('show');
        citadelPanel.setAttribute('aria-hidden', 'true');
        citadelBtn.setAttribute('aria-expanded', 'false');
      }
    };

    let openC = false;
    const toggleC = () => {
      openC = !openC; setPanelC(openC);
      if (openC && toodaPanel) {
        toodaPanel.classList.remove('show');
        toodaPanel.setAttribute('aria-hidden', 'true');
        if (toodaBtn) toodaBtn.setAttribute('aria-expanded', 'false');
      }
    };
    citadelBtn.addEventListener('click', (e) => { triggerBtnFX(citadelBtn, e); toggleC(); });
    citadelBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        triggerBtnFX(citadelBtn);
        toggleC();
      }
    });
    document.addEventListener('click', (e) => {
      const po = document.getElementById('proof-overlay');
      if (po && po.classList.contains('show')) return;
      if (!openC) return;
      const t = e.target;
      if (!citadelPanel.contains(t) && t !== citadelBtn) { openC = false; setPanelC(false); }
    });

    const header = citadelPanel.querySelector('.team-list h2');
    if (header) header.textContent = 'Citadel';
    const ul = citadelPanel.querySelector('.team-list .nick-list');
    if (ul) {
      ul.innerHTML = '';
      const items = ['status: ?'];
      items.forEach(txt => { const li = document.createElement('li'); li.textContent = txt; ul.appendChild(li); });
    }
    const storyWrap = citadelPanel.querySelector('.story');
    if (storyWrap) {
      const narrative = `February 2025 — I find an exploit in Discord VoIP’s RTC data and, using it, can down Discord VC offline — packet loss spikes to ~90%.
In mid-April I launch an attack on Telegram: 2/4 DCs plus web.telegram.org go down, and in under an hour Downdetector received about ~10k reports.`;
      storyWrap.innerHTML = `<p>${narrative}</p>`;
    }
  }

  if (citadelPanel) {
    const sW = citadelPanel.querySelector('.story');
    if (sW) {
      const narrativeParts = [
        'February 2025 — I find an exploit in Discord VoIP’s RTC data and, using it, can down Discord VC offline — packet loss spikes to ~90%.',
        'In mid-April I launch an attack on Telegram: 2/4 DCs plus web.telegram.org go down. Peak push reached 3.1 Tbps. <a href=\"#\" class=\"proof-link proof-highlight\" data-src=\"files/proof.avif\">Avg user reports ~10k. Down status held ~1h. Status: ?</a>',
        'April 17 — Telegram users began reporting widespread service disruptions. The first issues appeared around 19:30 MSK, and reports on Downradar and Downdetector started rapidly increasing. Users noted messages weren’t being delivered; for some, chats and media failed to load.'
      ];
      sW.innerHTML = narrativeParts.map(p => `<p>${p}</p>`).join('');
    }
  }

  const proofOverlay = document.getElementById('proof-overlay');
  const proofImg = document.getElementById('proof-img');
  const isSafeProofSrc = (raw) => {
    try {
      if (!raw) return null;
      const src = String(raw).trim();
      const lower = src.toLowerCase();
      if (lower.startsWith('javascript:') || lower.startsWith('data:') || lower.startsWith('vbscript:')) return null;
      const url = new URL(src, window.location.origin);
      if (url.origin !== window.location.origin) return null;
      const path = url.pathname;
      if (!path.startsWith('/files/')) return null;
      const allowed = ['.png', '.jpg', '.jpeg', '.webp', '.gif', '.avif'];
      const okExt = allowed.some(ext => path.toLowerCase().endsWith(ext));
      if (!okExt) return null;
      return url.pathname + url.search + url.hash;
    } catch (e) { return null; }
  };
  const openProof = (src) => {
    if (!proofOverlay || !proofImg) return;
    proofImg.src = src;
    proofOverlay.classList.add('show');
    proofOverlay.setAttribute('aria-hidden', 'false');
  };
  const closeProof = () => {
    if (!proofOverlay || !proofImg) return;
    proofOverlay.classList.remove('show');
    proofOverlay.setAttribute('aria-hidden', 'true');
    setTimeout(() => { proofImg.src = ''; }, 220);
  };
  if (proofOverlay) {
    proofOverlay.addEventListener('click', closeProof);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeProof(); });
  }
  document.addEventListener('click', (e) => {
    const a = e.target.closest && e.target.closest('.proof-link');
    if (a) {
      e.preventDefault();
      const raw = a.getAttribute('data-src') || a.getAttribute('href');
      const safe = isSafeProofSrc(raw);
      if (safe) openProof(safe);
    }
  });
});
